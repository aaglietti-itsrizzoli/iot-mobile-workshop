<html>

<head>
    <link rel="shortcut icon" href="/static/favicon.ico">

</head>

<body>
    <button onclick="startListen()">START LISTEN</button>
    <h2 id="eventsCount"></h2>
    <h2 id="lastMessageOn"></h2>
    <h2 id="blue" style="color: blue"></h2>
    <h2 id="red" style="color: red"></h2>
    <h2 id="yellow" style="color: yellow"></h2>
    <h2 id="green" style="color: green"></h2>
    <div id="chart_div_x"></div>
    <div id="chart_div_y"></div>
    <div id="chart_div_z"></div>
    <script>
        var socket = new WebSocket("wss://" + window.location.hostname + "/echo");
        var events = [];
        var rowsX = [];
        var rowsY = [];
        var rowsZ = [];
        var teams = {
            blue: [],
            red: [],
            yellow: [],
            green: [],
        }

        socket.onopen = function () {
            console.log("onopen", { _: new Date(), readyState: socket.readyState });
        }

        socket.onmessage = function (msg) {
            // console.log("onmessage", { _: new Date(), msg });
            events.push(msg);
            document.getElementById('eventsCount').innerHTML = events.length;
            document.getElementById('lastMessageOn').innerHTML = new Date().toISOString();

            var event = JSON.parse(msg.data);
            var _ = new Date(event.new_val.event._);
            var x = event.new_val.event.x;
            var y = event.new_val.event.y;
            var z = event.new_val.event.z;
            var team = event.new_val.team;
            var fingerprint = event.new_val.fingerprint;
            if (teams[team].indexOf(fingerprint) === -1) {
                teams[team].push(fingerprint);
                document.getElementById(team).innerHTML = teams[team].length;
            }
            var teamIndex = [
                'blue',
                'red',
                'yellow',
                'green',
            ];
            var previousRowX = rowsX.length > 0 ? rowsX[rowsX.length - 1] : [null, null, null, null, null];
            var rowX = [...previousRowX];
            rowX[0] = _;
            rowX[teamIndex.indexOf(team) + 1] = x;
            rowsX.push(rowX);
            console.log("onmessage new rowX", { _: new Date(), row: rowsX[rowsX.length - 1] });
            chartDataX.addRow(rowX);
            var totalRowsX = chartDataX.getNumberOfRows();
            if (totalRowsX > 50) {
                chartDataX.removeRows(0, totalRowsX - 50);
            }

            chartX.draw(chartDataX, chartOptions);

            var previousRowY = rowsY.length > 0 ? rowsY[rowsY.length - 1] : [null, null, null, null, null];
            var rowY = [...previousRowY];
            rowY[0] = _;
            rowY[teamIndex.indexOf(team) + 1] = y;
            rowsY.push(rowY);
            console.log("onmessage new rowY", { _: new Date(), row: rowsY[rowsY.length - 1] });
            chartDataY.addRow(rowY);
            var totalRowsY = chartDataY.getNumberOfRows();
            if (totalRowsY > 50) {
                chartDataY.removeRows(0, totalRowsY - 50);
            }

            chartY.draw(chartDataY, chartOptions);

            var previousRowZ = rowsZ.length > 0 ? rowsZ[rowsZ.length - 1] : [null, null, null, null, null];
            var rowZ = [...previousRowZ];
            rowZ[0] = _;
            rowZ[teamIndex.indexOf(team) + 1] = z;
            rowsZ.push(rowZ);
            console.log("onmessage new rowZ", { _: new Date(), row: rowsZ[rowsZ.length - 1] });
            chartDataZ.addRow(rowZ);
            var totalRowsZ = chartDataZ.getNumberOfRows();
            if (totalRowsZ > 50) {
                chartDataZ.removeRows(0, totalRowsZ - 50);
            }

            chartZ.draw(chartDataZ, chartOptions);
        }

        socket.onclose = function () {
            console.log("onclose", { _: new Date(), readyState: socket.readyState });
        }

        function startListen() {
            socket.send('hello world');
        }
    </script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
        google.charts.load('current', { packages: ['corechart', 'line'] });
        google.charts.setOnLoadCallback(drawCrosshairs);
        var chartOptions = {};
        var chartDataX = null;
        var chartDataY = null;
        var chartDataZ = null;
        var chartX = null;
        var chartY = null;
        var chartZ = null;

        function drawCrosshairs() {
            chartDataX = new google.visualization.DataTable();
            chartDataX.addColumn('datetime', 'time');
            chartDataX.addColumn('number', 'Xblue');
            chartDataX.addColumn('number', 'Xred');
            chartDataX.addColumn('number', 'Xyellow');
            chartDataX.addColumn('number', 'Xgreen');

            chartDataX.addRow([new Date(), 0, 0, 0, 0]);

            chartX = new google.visualization.LineChart(document.getElementById('chart_div_x'));

            chartX.draw(chartDataX, chartOptions);

            chartDataY = new google.visualization.DataTable();
            chartDataY.addColumn('datetime', 'time');
            chartDataY.addColumn('number', 'Yblue');
            chartDataY.addColumn('number', 'Yred');
            chartDataY.addColumn('number', 'Yyellow');
            chartDataY.addColumn('number', 'Ygreen');

            chartDataY.addRow([new Date(), 0, 0, 0, 0]);

            chartY = new google.visualization.LineChart(document.getElementById('chart_div_y'));

            chartY.draw(chartDataY, chartOptions);

            chartDataZ = new google.visualization.DataTable();
            chartDataZ.addColumn('datetime', 'time');
            chartDataZ.addColumn('number', 'Zblue');
            chartDataZ.addColumn('number', 'Zred');
            chartDataZ.addColumn('number', 'Zyellow');
            chartDataZ.addColumn('number', 'Zgreen');

            chartDataZ.addRow([new Date(), 0, 0, 0, 0]);

            chartZ = new google.visualization.LineChart(document.getElementById('chart_div_z'));

            chartZ.draw(chartDataZ, chartOptions);
        }
    </script>
</body>

</html>